# 磁盘模拟文件系统

## 项目简介

本项目是一个基于 C++ 实现的用户态磁盘模拟文件系统，通过单个文件模拟物理磁盘块设备，实现了文件系统的核心功能，包括磁盘格式化、挂载 / 卸载、文件创建 / 读写 / 删除、目录管理等。系统采用固定块大小（4KB）管理磁盘空间，严格划分超级块、位图区、inode 区和数据区，模拟真实文件系统的底层存储逻辑。

## 项目结构

```plaintext
disk_simulator/
├── include/                 # 头文件目录
│   ├── disk_fs.h            # 核心数据结构（超级块、inode、目录项等）及接口定义
│   └── command_parser.h     # 命令解析器接口定义
├── src/                     # 源文件目录
│   ├── main.cpp             # 主程序入口，处理命令交互
│   ├── disk_init.cpp        # 磁盘初始化（格式化、挂载、卸载）实现
│   ├── bitmap_ops.cpp       # 块位图与inode位图的分配/回收操作
│   ├── pos_calc.cpp         # 计算磁盘块、inode在文件中的偏移量
│   ├── block_ops.cpp        # 磁盘块的读写操作
│   ├── file_ops.cpp         # 文件操作（创建、读写、删除、列表等）实现
│   └── command_parser.cpp   # 命令解析与执行逻辑
├── test/                    # 测试目录
│   └── test_main.cpp        # 单元测试与集成测试代码
├── Makefile                 # 编译脚本
└── README.md                # 项目说明文档
```

## 磁盘布局

磁盘文件采用固定分区结构，从起始位置到末尾依次划分为 5 个区域，所有操作均以**块（BLOCK_SIZE=4096 字节）** 为单位：

1. **超级块（Super Block）**：占用 1 个块，存储文件系统元数据，包括：
   - 文件系统标识（`SIMFSv1`）
   - 块大小、总块数、数据块数量
   - 总 inode 数、空闲 inode / 块数量
   - 各区域（块位图、inode 位图、inode 区、数据区）的起始块号
2. **块位图**：记录数据块的使用状态（0 = 空闲，1 = 已使用），占用空间根据总块数计算。
3. **inode 位图**：记录 inode 的使用状态（0 = 空闲，1 = 已使用），占用空间根据总 inode 数计算。
4. **inode 区**：存储所有 inode 结构，每个 inode 记录文件类型（普通文件 / 目录）、大小、数据块指针、创建 / 修改时间等信息。
5. **数据区**：存储文件实际内容和目录项数据，是文件系统的主要存储空间。

## 编译与运行

### 编译项目

```bash
# 编译主程序（生成sim_disk可执行文件）
make sim_disk

# 编译测试程序（生成test_disk可执行文件）
make test
```

### 运行模拟器

```bash
# 启动模拟器，指定模拟磁盘文件（如disk.img）
./sim_disk disk.img
```

### 运行测试

```bash
# 执行自动测试（测试文件为test_disk.img）
make test && ./test_disk
```

## 支持命令

启动模拟器后，可通过以下命令操作文件系统：

| 命令格式               | 功能描述                                   | 示例                                     |
| ---------------------- | ------------------------------------------ | ---------------------------------------- |
| `format`               | 格式化磁盘（清空数据，初始化文件系统结构） | `format`                                 |
| `mount`                | 挂载磁盘（加载文件系统到内存）             | `mount`                                  |
| `umount`               | 卸载磁盘（将内存数据写回磁盘并关闭）       | `umount`                                 |
| `create <文件名>`      | 在根目录创建文件，返回 inode 编号          | `create example.txt`                     |
| `open <文件名>`        | 查找文件并返回 inode 编号（类似打开文件）  | `open example.txt`                       |
| `read <inode> <大小>`  | 从指定 inode 读取指定大小的内容            | `read 1 100`（从 inode=1 读取 100 字节） |
| `write <inode> <内容>` | 向指定 inode 写入内容（覆盖偏移量 0 开始） | `write 1 "hello world"`                  |
| `delete <文件名>`      | 删除根目录中的文件                         | `delete example.txt`                     |
| `ls`                   | 列出根目录中所有文件（含 inode 编号）      | `ls`                                     |
| `info`                 | 显示磁盘信息（总块数、空闲块数等）         | `info`                                   |
| `help`                 | 查看所有支持的命令                         | `help`                                   |
| `exit`                 | 退出模拟器（自动卸载磁盘）                 | `exit`                                   |

## 核心功能说明

1. **磁盘格式化（`format`）**

   初始化磁盘文件结构，创建超级块、块位图、inode 位图，分配根目录 inode（0 号）并初始化根目录数据块（包含当前目录`.`条目）。

2. **挂载与卸载（`mount`/`umount`）**

   - 挂载：验证文件系统标识（`SIMFSv1`），加载超级块到内存。
   - 卸载：将内存中的超级块（含最新空闲块 /inode 计数）写回磁盘，关闭文件。

3. **文件操作**

   - 基于 inode 管理文件元数据，通过数据块存储内容。
   - 支持跨块读写，自动分配新数据块（当写入内容超过现有块大小时）。
   - 根目录为单层结构，所有文件直接存储在根目录下。

4. **空间管理**

   - 采用位图（bitmap）机制管理 inode 和数据块的分配与回收，确保高效查询空闲资源。
   - 每次分配 / 回收操作同步更新超级块中的空闲计数。

## 测试说明

测试程序（`test_main.cpp`）自动验证以下功能：

1. 磁盘格式化与挂载
2. 文件创建（含同名文件冲突检测）
3. 文件写入与读取
4. 目录列表（`ls`）功能
5. 文件删除与删除验证
6. 磁盘卸载

运行测试后将输出总测试数、通过数和失败数，确保核心功能正确性。

## 注意事项

1. 格式化操作会清空磁盘文件中的所有数据，请谨慎使用。
2. 磁盘文件默认名为`disk.img`，测试专用磁盘为`test_disk.img`（已加入`.gitignore`）。
3. 文件名长度限制为`MAX_FILENAME-1`（含终止符，定义在头文件中）。
4. 所有操作需在磁盘挂载（`mount`）后执行，否则会提示失败。
